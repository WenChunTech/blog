# Btrfsæ–‡ä»¶ç³»ç»Ÿ


<!--more-->
# Btrfsæ–‡ä»¶ç³»ç»Ÿä»‹ç»

## 1. Btrfsç®€ä»‹

  Btrfs æ˜¯ä¸€ç§æ–°åž‹çš„å†™æ—¶å¤åˆ¶ï¼ˆCoWï¼‰Linux æ–‡ä»¶ç³»ç»Ÿï¼Œå·²ç»å¹¶å…¥å†…æ ¸ä¸»çº¿ã€‚ä½ å¯ä»¥è¯»ä½œ Better File Systemã€B-tree File Systemã€Butter File System ç­‰ç­‰ï¼Œéƒ½æ˜¯æ­£ç¡®çš„ã€‚Btrfs åœ¨è®¾è®¡å®žçŽ°é«˜çº§åŠŸèƒ½çš„åŒæ—¶ï¼Œç€é‡äºŽå®¹é”™ã€ä¿®å¤ä»¥åŠæ˜“äºŽç®¡ç†ã€‚å®ƒç”± Oracleã€Red Hatã€Fujitsuã€Intelã€SUSEã€STRATO ç­‰ä¼ä¸šå’Œå¼€å‘è€…å…±åŒå¼€å‘ã€‚Btrfs ä»¥ GNU GPL åè®®æŽˆæƒï¼ŒåŒæ—¶ä¹Ÿæ¬¢è¿Žä»»ä½•äººçš„è´¡çŒ®ã€‚

## 2. Btrfsçš„ç‰¹æ€§

#### æ‰©å±•æ€§ç›¸å…³

1. B-tree
   - Btrfs æ–‡ä»¶ç³»ç»Ÿä¸­æ‰€æœ‰çš„ metadata éƒ½ç”± B-tree ç®¡ç†ã€‚ä½¿ç”¨ B-tree çš„ä¸»è¦å¥½å¤„åœ¨äºŽæŸ¥æ‰¾ã€æ’å…¥å’Œåˆ é™¤æ“ä½œéƒ½å¾ˆé«˜æ•ˆã€‚å¯ä»¥è¯´ B-tree æ˜¯ Btrfs çš„æ ¸å¿ƒ
2. åŸºäºŽ Extent çš„æ–‡ä»¶å­˜å‚¨
3. âœ… é’ˆå¯¹ SSD çš„ä¼˜åŒ–æ”¯æŒ
   - Btrfs çš„ CoW æŠ€æœ¯ä»Žæ ¹æœ¬ä¸Šé¿å…äº†å¯¹åŒä¸€ä¸ªç‰©ç†å•å…ƒçš„åå¤å†™æ“ä½œã€‚å¦‚æžœç”¨æˆ·æ‰“å¼€äº† SSD ä¼˜åŒ–é€‰é¡¹ï¼ŒBtrfs å°†åœ¨åº•å±‚çš„å—ç©ºé—´åˆ†é…ç­–ç•¥ä¸Šè¿›è¡Œä¼˜åŒ–ï¼šå°†å¤šæ¬¡ç£ç›˜ç©ºé—´åˆ†é…è¯·æ±‚èšåˆæˆä¸€ä¸ªå¤§å°ä¸º 2M çš„è¿žç»­çš„å—ã€‚å¤§å—è¿žç»­åœ°å€çš„ IO èƒ½å¤Ÿè®©å›ºåŒ–åœ¨ SSD å†…éƒ¨çš„å¾®ä»£ç æ›´å¥½çš„è¿›è¡Œè¯»å†™ä¼˜åŒ–ï¼Œä»Žè€Œæé«˜ I/O æ€§èƒ½
4. åŠ¨æ€ Inode åˆ†é…
5. æ”¯æŒéžå¸¸å¤§çš„å•ä¸ªæ–‡ä»¶å¤§å°

#### æ•°æ®ä¸€è‡´æ€§ç›¸å…³

1. âœ… å†™æ—¶å¤åˆ¶ï¼ˆCoWï¼‰
   - æ¯”å°±åœ°ä¿®æ”¹çš„æ–‡ä»¶ç³»ç»Ÿæœ‰æ›´å¤§çš„å¥½å¤„ï¼Œè¯¦ç»†çš„è¯´æ˜Žè§ä¸‹æ–‡
2. æ ¡éªŒå’Œï¼ˆChecksumï¼‰
   - ä¿è¯äº†æ•°æ®çš„å¯é æ€§ï¼šç”±äºŽç¡¬ä»¶åŽŸå› ï¼Œä»Žç£ç›˜ä¸Šè¯»å‡ºçš„æ•°æ®ä¼šå‡ºé”™ã€‚æ¯”å¦‚ block A ä¸­å­˜æ”¾çš„æ•°æ®ä¸º 0x55ï¼Œä½†è¯»å–å‡ºæ¥çš„æ•°æ®å˜æˆäº† 0x54ï¼Œå› ä¸ºè¯»å–æ“ä½œå¹¶æœªæŠ¥é”™ï¼Œæ‰€ä»¥è¿™ç§é”™è¯¯ä¸èƒ½è¢«ä¸Šå±‚è½¯ä»¶æ‰€å¯Ÿè§‰ã€‚è§£å†³è¿™ä¸ªé—®é¢˜çš„æ–¹æ³•æ˜¯ä¿å­˜æ•°æ®çš„æ ¡éªŒå’Œï¼Œåœ¨è¯»å–æ•°æ®åŽæ£€æŸ¥æ ¡éªŒå’Œã€‚å¦‚æžœä¸ç¬¦åˆï¼Œä¾¿çŸ¥é“æ•°æ®å‡ºçŽ°äº†é”™è¯¯ã€‚å¦‚æžœæœ€ç»ˆä»Žç£ç›˜è¯»å–å‡ºæ¥çš„æ•°æ®å’Œ checksum ä¸ç›¸åŒï¼ŒBtrfs ä¼šé¦–å…ˆå°è¯•è¯»å–æ•°æ®çš„é•œåƒå¤‡ä»½ï¼Œå¦‚æžœæ•°æ®æ²¡æœ‰é•œåƒå¤‡ä»½ï¼ŒBtrfs å°†è¿”å›žé”™è¯¯ã€‚å†™å…¥ç£ç›˜æ•°æ®ä¹‹å‰ï¼ŒBtrfs è®¡ç®—æ•°æ®çš„ checksumã€‚ç„¶åŽå°† checksum å’Œæ•°æ®åŒæ—¶å†™å…¥ç£ç›˜ã€‚

#### å¤šè®¾å¤‡ç®¡ç†ç›¸å…³

1. âœ… å¤šè®¾å¤‡ç®¡ç†
   - Btrfs æ”¯æŒåŠ¨æ€æ·»åŠ è®¾å¤‡ã€‚ç”¨æˆ·åœ¨ç³»ç»Ÿä¸­å¢žåŠ æ–°çš„ç£ç›˜ä¹‹åŽï¼Œå¯ä»¥ä½¿ç”¨ `btrfs` çš„ç›¸å…³å‘½ä»¤å°†è¯¥è®¾å¤‡æ·»åŠ åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­
2. âœ… å­å·ï¼ˆSubvolumeï¼‰
   - æŠŠæ–‡ä»¶ç³»ç»Ÿçš„ä¸€éƒ¨åˆ†é…ç½®ä¸ºä¸€ä¸ªå®Œæ•´çš„å­æ–‡ä»¶ç³»ç»Ÿ
3. âœ… å¿«ç…§ï¼ˆSnapshotï¼‰å’Œå…‹éš†ï¼ˆCloneï¼‰
   - æ”¯æŒå¿«ç…§
   - æ”¯æŒå¿«ç…§çš„å¿«ç…§ï¼ˆå¢žé‡å¤‡ä»½ï¼‰
   - å¯ä»¥å¯¹å•ä¸ªæ–‡ä»¶è¿›è¡Œå¤‡ä»½
4. âœ… å†…ç½®æ”¯æŒ RAIDï¼Œæ”¯æŒæ¡å¸¦æˆ– mirror ç­‰å¸¸è§çš„ RAID åŠŸèƒ½
5. âœ… æ”¯æŒçƒ­ç§»é™¤ã€çƒ­æ·»åŠ è®¾å¤‡

#### å…¶ä»–ç‰¹æ€§

1. âœ… é€æ˜ŽåŽ‹ç¼©
   - å‡å°äº†æ–‡ä»¶çš„å¤§å°ï¼Œé€šè¿‡å‡å°‘æ–‡ä»¶å†™å…¥å¢žå¹…æ¥æ˜¾è‘—å»¶é•¿é—ªå­˜ä»‹è´¨çš„å¯¿å‘½ã€‚åœ¨æŸäº›ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚å•çº¿ç¨‹ã€é‡è´Ÿè·çš„æ–‡ä»¶ I/Oï¼‰è¿˜æé«˜äº†æ€§èƒ½
2. å»¶è¿Ÿåˆ†é…ï¼ˆDelay allocationï¼‰
   - åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œå°å—ç©ºé—´é¢‘ç¹çš„åˆ†é…å’Œé‡Šæ”¾ä¼šé€ æˆç¢Žç‰‡ã€‚å»¶è¿Ÿåˆ†é…åˆ™æ˜¯è¿™æ ·ä¸€ç§æŠ€æœ¯ â€”â€” å½“ç”¨æˆ·éœ€è¦ç£ç›˜ç©ºé—´æ—¶ï¼Œå…ˆå°†æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­ã€‚å°†ç£ç›˜åˆ†é…éœ€æ±‚å‘é€ç»™ç£ç›˜ç©ºé—´åˆ†é…å™¨ï¼Œç£ç›˜ç©ºé—´åˆ†é…å™¨å¹¶ä¸ç«‹å³åˆ†é…çœŸæ­£çš„ç£ç›˜ç©ºé—´ã€‚åªæ˜¯è®°å½•ä¸‹è¿™ä¸ªè¯·æ±‚ä¾¿è¿”å›žã€‚ç£ç›˜ç©ºé—´åˆ†é…è¯·æ±‚å¯èƒ½å¾ˆé¢‘ç¹ï¼Œæ‰€ä»¥åœ¨å»¶è¿Ÿåˆ†é…çš„ä¸€æ®µæ—¶é—´å†…ï¼Œç£ç›˜åˆ†é…å™¨å¯ä»¥æ”¶åˆ°å¾ˆå¤šçš„åˆ†é…è¯·æ±‚ â€”â€” ä¸€äº›è¯·æ±‚ä¹Ÿè®¸å¯ä»¥åˆå¹¶ï¼Œä¸€äº›è¯·æ±‚åœ¨è¿™æ®µå»¶è¿ŸæœŸé—´ç”šè‡³å¯èƒ½è¢«å–æ¶ˆã€‚é€šè¿‡è¿™æ ·çš„â€œç­‰å¾…â€ï¼Œå¾€å¾€èƒ½å¤Ÿå‡å°‘ä¸å¿…è¦çš„åˆ†é…ï¼Œä¹Ÿæœ‰å¯èƒ½å°†å¤šä¸ªå°çš„åˆ†é…è¯·æ±‚åˆå¹¶ä¸ºä¸€ä¸ªå¤§çš„è¯·æ±‚ï¼Œä»Žè€Œæé«˜ I/O æ•ˆçŽ‡
3. Inline File
   - ç³»ç»Ÿä¸­å¾€å¾€å­˜åœ¨å¤§é‡çš„å°æ–‡ä»¶ï¼ˆå‡ ç™¾ä¸ªå­—èŠ‚æˆ–è€…æ›´å°ï¼‰ã€‚å¦‚æžœä¸ºå…¶åˆ†é…å•ç‹¬çš„æ•°æ® blockï¼Œä¾¿ä¼šå¼•èµ·å†…éƒ¨ç¢Žç‰‡ï¼Œæµªè´¹ç£ç›˜ç©ºé—´ã€‚Btrfs å°†å°æ–‡ä»¶çš„å†…å®¹ä¿å­˜åœ¨å…ƒæ•°æ®ä¸­ï¼Œä¸å†é¢å¤–åˆ†é…å­˜æ”¾æ–‡ä»¶æ•°æ®çš„ç£ç›˜å—ã€‚æ”¹å–„äº†å†…éƒ¨ç¢Žç‰‡é—®é¢˜ï¼Œä¹Ÿå¢žåŠ äº†æ–‡ä»¶çš„è®¿é—®æ•ˆçŽ‡ã€‚å¾—ç›ŠäºŽ Inline File æŠ€æœ¯ï¼ŒBtrfs å¤„ç†å°æ–‡ä»¶çš„æ•ˆçŽ‡éžå¸¸é«˜ï¼Œä¹Ÿé¿å…äº†ç£ç›˜ç¢Žç‰‡é—®é¢˜
4. ç›®å½•ç´¢å¼•ï¼ˆDirectory Indexï¼‰
   - å½“ä¸€ä¸ªç›®å½•ä¸‹çš„æ–‡ä»¶æ•°ç›®å·¨å¤§æ—¶ï¼Œç›®å½•ç´¢å¼•å¯ä»¥æ˜¾è‘—æé«˜æ–‡ä»¶æœç´¢æ—¶é—´ã€‚ Btrfs æœ¬èº«é‡‡ç”¨ B-tree å­˜å‚¨ç›®å½•é¡¹ï¼Œæ‰€ä»¥åœ¨ç»™å®šç›®å½•ä¸‹æœç´¢æ–‡ä»¶çš„æ•ˆçŽ‡æ˜¯éžå¸¸é«˜çš„ã€‚ç„¶è€Œï¼ŒBtrfs ä½¿ç”¨ B-tree ç®¡ç†ç›®å½•é¡¹çš„æ–¹å¼æ— æ³•åŒæ—¶æ»¡è¶³ readdir çš„éœ€æ±‚ã€‚readdir æ˜¯ POSIX æ ‡å‡† APIï¼Œå®ƒè¦æ±‚è¿”å›žæŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼›å¹¶ä¸”ç‰¹åˆ«çš„ï¼Œè¿™äº›æ–‡ä»¶è¦æŒ‰ç…§ inode number æŽ’åºã€‚è€Œ Btrfs ç›®å½•é¡¹æ’å…¥ B-tree æ—¶çš„ Key å¹¶ä¸æ˜¯ inode numberï¼Œè€Œæ˜¯æ ¹æ®æ–‡ä»¶åè®¡ç®—çš„ä¸€ä¸ª hash å€¼ã€‚è¿™ç§æ–¹å¼åœ¨æŸ¥æ‰¾ä¸€ä¸ªç‰¹å®šæ–‡ä»¶æ—¶éžå¸¸é«˜æ•ˆï¼Œä½†å´ä¸é€‚äºŽ readdir ã€‚ä¸ºæ­¤ï¼ŒBtrfs åœ¨æ¯æ¬¡åˆ›å»ºæ–°çš„æ–‡ä»¶æ—¶ï¼Œé™¤äº†æ’å…¥ä»¥ hash å€¼ä¸º Key çš„ç›®å½•é¡¹å¤–ï¼Œè¿˜åŒæ—¶æ’å…¥å¦å¤–ä¸€ç§ç›®å½•é¡¹ç´¢å¼•ï¼Œè¯¥ç›®å½•é¡¹ç´¢å¼•çš„ Key ä»¥ sequence number ä½œä¸º B-tree çš„é”®å€¼ã€‚è¿™ä¸ª sequence number åœ¨æ¯æ¬¡åˆ›å»ºæ–°æ–‡ä»¶æ—¶çº¿æ€§å¢žåŠ ã€‚å› ä¸º Inode number ä¹Ÿæ˜¯æ¯æ¬¡åˆ›å»ºæ–°æ–‡ä»¶æ—¶å¢žåŠ çš„ï¼Œæ‰€ä»¥ sequence number å’Œ inode number çš„é¡ºåºç›¸åŒã€‚ä»¥è¿™ç§ sequence number ä½œä¸º Key åœ¨ B-tree ä¸­æŸ¥æ‰¾ä¾¿å¯ä»¥æ–¹ä¾¿çš„å¾—åˆ°ä¸€ä¸ªä»¥ inode number æŽ’åºçš„æ–‡ä»¶åˆ—è¡¨
   - å¦å¤–ä»¥ sequence number æŽ’åºçš„æ–‡ä»¶å¾€å¾€åœ¨ç£ç›˜ä¸Šçš„ä½ç½®ä¹Ÿæ˜¯ç›¸é‚»çš„ï¼Œæ‰€ä»¥ä»¥ sequence number ä¸ºåºè®¿é—®å¤§é‡æ–‡ä»¶ä¼šèŽ·å¾—æ›´å¥½çš„ I/O æ•ˆçŽ‡
5. é¢„åˆ†é…
   - å¾ˆå¤šåº”ç”¨ç¨‹åºæœ‰é¢„å…ˆåˆ†é…ç£ç›˜ç©ºé—´çš„éœ€è¦ã€‚ä»–ä»¬å¯ä»¥é€šè¿‡ `posix_fallocate` æŽ¥å£å‘Šè¯‰æ–‡ä»¶ç³»ç»Ÿåœ¨ç£ç›˜ä¸Šé¢„ç•™ä¸€éƒ¨åˆ†ç©ºé—´ï¼Œä½†æš‚æ—¶å¹¶ä¸å†™å…¥æ•°æ®ã€‚å¦‚æžœåº•å±‚æ–‡ä»¶ç³»ç»Ÿä¸æ”¯æŒ `fallocate`ï¼Œé‚£ä¹ˆåº”ç”¨ç¨‹åºåªæœ‰ä½¿ç”¨ `write` é¢„å…ˆå†™ä¸€äº›æ— ç”¨ä¿¡æ¯ä»¥ä¾¿ä¸ºè‡ªå·±é¢„ç•™è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ã€‚ç”±æ–‡ä»¶ç³»ç»Ÿæ¥æ”¯æŒé¢„ç•™ç©ºé—´æ›´åŠ æœ‰æ•ˆï¼Œè€Œä¸”èƒ½å¤Ÿå‡å°‘ç£ç›˜ç¢Žç‰‡ï¼Œå› ä¸ºæ‰€æœ‰çš„ç©ºé—´éƒ½æ˜¯ä¸€æ¬¡åˆ†é…ï¼Œå› è€Œæ›´æœ‰å¯èƒ½ä½¿ç”¨è¿žç»­çš„ç©ºé—´ã€‚ Btrfs æ”¯æŒ `posix_fallocate`

### Btrfs ä¸Žå…¶å®ƒæ–‡ä»¶ç³»ç»ŸåŠŸèƒ½æ¯”è¾ƒ[#](https://arch.icekylin.online/guide/advanced/btrfs.html#btrfs-ä¸Žå…¶å®ƒæ–‡ä»¶ç³»ç»ŸåŠŸèƒ½æ¯”è¾ƒ)

| Feature                       | Ext 2 / 3 | Ext 4 | ReiserFS | XFS     | OCFS2  | Btrfs      |
| :---------------------------- | :-------- | :---- | :------- | :------ | :----- | :--------- |
| Journal (date / metadata)     | âš« / âš«     | âš« / âš« | âšª / âš«    | âšª / âš«   | âšª / âš«  | **N/A**    |
| Journal (internal / external) | âš« / âš«     | âš« / âš« | âš« / âš«    | âš« / âš«   | âš« / âšª  | N/A        |
| Offline extend / shrink       | âš« / âš«     | âš« / âš« | âš« / âš«    | âšª / âšª   | âš« / âšª  | âš« / âš«      |
| Online extend / shrink        | âš« / âšª     | âš« / âšª | âš« / âšª    | âš« / âšª   | âš« / âšª  | âš« / âš«      |
| Inode allocation map          | table     | table | B*-tree  | B+-tree | table  | B-tree     |
| Sparse files                  | âš«         | âš«     | âš«        | âš«       | âš«      | âš«          |
| Tail packing                  | âšª         | âš«     | âš«        | âšª       | âšª      | âš«          |
| Defragmentation               | âšª         | âš«     | âšª        | âš«       | âšª      | âš«          |
| ExtArributes / ACLs           | âš« / âš«     | âš« / âš« | âš« / âš«    | âš« / âš«   | âš« / âš«  | âš« / âš«      |
| Quotas                        | âš«         | âš«     | âš«        | âš«       | âš«      | ðŸ”´          |
| Dump / restore                | âš«         | âš«     | âšª        | âš«       | âšª      | âšª          |
| Default block size            | 4 KiB     | 4 KiB | 4 KiB    | 4 KiB   | 4 KiB  | 4 KiB      |
| max. file system size         | 16 TiB    | 1 EiB | 16 TiB   | 8 EiB   | 4 PiB  | **16 EiB** |
| max. file size                | 2 TiB     | 1 EiB | 1 EiB    | 8 EiB   | 4 PiB  | **16 EiB** |
| Support status                | SLES      | SLES  | SLES     | SLES    | SLE HA | SLES       |

## 3. Barfsçš„ç®€å•ä½¿ç”¨

3.1 åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿ

```bash
mkfs.btrfs -f /dev/sda1
```

3.2 æŒ‚è½½æ–‡ä»¶ç³»ç»Ÿ

```bash
mount /dev/sda1 /mnt
```
3.3 åˆ›å»ºå­å·

```bash
btrfs subvolume create subvolume_name
```
3.4 åˆ é™¤å­å·

```bash
btrfs subvolume delete subvolume_name
# or
rm -rf subvolume_name
```
3.5 åˆ›å»ºå¿«ç…§

```bash
btrfs subvolume snapshot source destination
```
3.6 åˆ é™¤å¿«ç…§

```bash
btrfs subvolume delete snapshot_name
```
3.7 æŸ¥çœ‹å¿«ç…§

```bash
btrfs subvolume list /mnt
```
3.8 æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿä¿¡æ¯

```bash
btrfs filesystem show /mnt
```
3.9 æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿä½¿ç”¨æƒ…å†µ

```bash
btrfs filesystem df /mnt
```
3.10 æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿçš„åŽ‹ç¼©æƒ…å†µ

```bash
btrfs filesystem df -c /mnt
```
3.11 æŸ¥çœ‹æ–‡ä»¶ç³»ç»Ÿçš„åŽ‹ç¼©ç®—æ³•

```bash
btrfs filesystem df -c /mnt
```
3.12 æŸ¥çœ‹å­å·ä¿¡æ¯

```bash
btrfs subvolume show /mnt
```

---

> ä½œè€…: map[avatar:<nil> email:<nil> link:<nil> name:<nil>]  
> URL: https://blog-12x.pages.dev/btrfs%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/  

